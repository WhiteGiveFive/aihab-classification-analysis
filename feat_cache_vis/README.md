# feat_cache_vis

Dash viewer for cached embedding coordinates with an image panel and optional LLM rationale display.

## Required Files
The app expects a cache directory that contains:
- `metadata.csv`, can be generated by the `aihab-clip` project.
- A coords file (e.g., `vis_umap_coords.npy`), containing 2D features, can be generated by the `aihab-clip` project. Samples in `metadata.csv` and the coord file must be paired. They are used together.
- Optional:
  - `mis_Qwen_Qwen3-VL-4B-Instruct.csv`, can be generated by the `aihab-llm` project. 
  - `correct_Qwen_Qwen3-VL-4B-Instruct.csv`, can be generated by the `aihab-llm` project.

Example cache directory:
`feat_cache_vis/hf-hub_timm_ViT-SO400M-16-SigLIP2-384_cs/test/seed1`

## Install Dependencies
```bash
python -m pip install dash plotly numpy pandas
```

## Run (Serve Images From Dash)
From the repo root:
```bash
python feat_cache_vis/feat_vis_dash.py \
  --cache_dir feat_cache_vis/hf-hub_timm_ViT-SO400M-16-SigLIP2-384_cs/test/seed1 \
  --coords_file vis_umap_coords.npy \
  --image_dir CS_Xplots_2019_2023_test \
  --host 127.0.0.1 \
  --port 8050
```

## Run (No Images)
```bash
python feat_cache_vis/feat_vis_dash.py \
  --cache_dir feat_cache_vis/hf-hub_timm_ViT-SO400M-16-SigLIP2-384_cs/test/seed1 \
  --coords_file vis_umap_coords.npy \
  --host 127.0.0.1 \
  --port 8050
```

## LLM Rationale Inputs
The app parses the `rationale` column (JSON) in the mis/correct CSVs and shows:
- `prediction` (misclassification or correct classification)
- `LLM score`
- `LLM rationale`

Defaults (relative to `--cache_dir`):
- `--mis_csv mis_Qwen_Qwen3-VL-4B-Instruct.csv`
- `--correct_csv correct_Qwen_Qwen3-VL-4B-Instruct.csv`

You can override them:
```bash
--mis_csv your_mis.csv --correct_csv your_correct.csv
```

## Other Options
- `--color_by` (default: `ground_truth_word_label`)
- `--hover` (default: `file_name,ground_truth_word_label,ground_truth_num_label`)
- `--image_root` (URL prefix if you already host images elsewhere)

## Notes
- Images are resolved by `file_name` and served from `--image_dir` at `/images/<file_name>`.
- The app is self-hosted and uses only local data.
