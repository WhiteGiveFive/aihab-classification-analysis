# feat_cache_vis

Dash viewer for cached embedding coordinates with an image panel and optional LLM rationale display.

## Required Files
The app expects a cache directory that contains:
- `metadata.csv`, can be generated by the `aihab-clip` project.
- A coords file (e.g., `vis_umap_coords.npy`), containing 2D features, can be generated by the `aihab-clip` project. Samples in `metadata.csv` and the coord file must be paired. They are used together.
- Optional:
  - `mis_Qwen_Qwen3-VL-4B-Instruct.csv`, can be generated by the `aihab-llm` project. 
  - `correct_Qwen_Qwen3-VL-4B-Instruct.csv`, can be generated by the `aihab-llm` project.
  - `scores_centroid.csv`
  - `scores_multiprototype_5pct.csv`
  - `scores_multiprototype_10pct.csv`
  - `scores_multiprototype_15pct.csv`
  - `scores_multiprototype_20pct.csv`

Example cache directory:
`feat_cache_vis/hf-hub_timm_ViT-SO400M-16-SigLIP2-384_cs/test/seed1`

## Install Dependencies
```bash
python -m pip install dash plotly numpy pandas
```

## Run (Serve Images From Dash)
From the repo root:
```bash
python feat_cache_vis/feat_vis_dash.py \
  --cache_dir feat_cache_vis/hf-hub_timm_ViT-SO400M-16-SigLIP2-384_cs/test/seed1 \
  --coords_file vis_umap_coords.npy \
  --image_dir CS_Xplots_2019_2023_test \
  --host 127.0.0.1 \
  --port 8050
```

## Run (No Images)
```bash
python feat_cache_vis/feat_vis_dash.py \
  --cache_dir feat_cache_vis/hf-hub_timm_ViT-SO400M-16-SigLIP2-384_cs/test/seed1 \
  --coords_file vis_umap_coords.npy \
  --host 127.0.0.1 \
  --port 8050
```

## LLM Rationale Inputs
The app parses the `rationale` column (JSON) in the mis/correct CSVs and shows:
- `prediction` (misclassification or correct classification)
- `LLM score`
- `LLM rationale`

Defaults (relative to `--cache_dir`):
- `--mis_csv mis_Qwen_Qwen3-VL-4B-Instruct.csv`
- `--correct_csv correct_Qwen_Qwen3-VL-4B-Instruct.csv`

You can override them:
```bash
--mis_csv your_mis.csv --correct_csv your_correct.csv
```

## Centroid Outlier Inputs
If `scores_centroid.csv` is present in the cache directory, the app:
- Uses `is_bottom_5pct` as one outlier source in the combined outlier overlay.

Override the default path (relative to `--cache_dir`) with:
```bash
--centroid_csv your_scores_centroid.csv
```

## Multi-Prototype Outlier Inputs
If `scores_multiprototype_5pct.csv`, `scores_multiprototype_10pct.csv`, `scores_multiprototype_15pct.csv`, and/or `scores_multiprototype_20pct.csv` are present in the cache directory, the app:
- Uses each `is_bottom_{pct}pct` flag as an outlier source in the combined outlier overlay.
- Shows all sources in the panel table with:
  - `Bottom Flag`
  - `sim_to_centroid`
  - `pct_rank_in_class`

Defaults (relative to `--cache_dir`):
- `--multiprototype_5pct_csv scores_multiprototype_5pct.csv`
- `--multiprototype_10pct_csv scores_multiprototype_10pct.csv`
- `--multiprototype_15pct_csv scores_multiprototype_15pct.csv`
- `--multiprototype_20pct_csv scores_multiprototype_20pct.csv`

## Outlier Controls
The graph includes controls above the scatter:
- Method toggles: `Centroid`, `Multi-prototype`
- Threshold slider: `5%`, `10%`, `15%`, `20%` with cumulative semantics (`<= threshold`)
- Review subset toggle: `Review subset only`
- Review LLM cutoff slider: integer `1..5` (default `3`)

Badge behavior:
- One outlier badge per point (single badge encoding).
- Badge size/color represents how many active sources flagged the point.
- If classes are shown via `--color_by`, badge visibility follows class legend toggles.

## Expert Review Subset Rule
When `Review subset only` is enabled, the graph is filtered to samples matching:
- `centroid_5 flag == True` OR
- `multiprototype_10 flag == True` OR
- `llm_score <= cutoff`

`llm_score` is parsed from `rationale.score` in both:
- `mis_Qwen_Qwen3-VL-4B-Instruct.csv`
- `correct_Qwen_Qwen3-VL-4B-Instruct.csv`

The panel shows:
- `Review subset match`
- `Review rules active`
- `Current LLM cutoff`
- A compact per-source table with `Used in Review Rule`.

## Other Options
- `--color_by` (default: `ground_truth_word_label`)
- `--hover` (default: `file_name,ground_truth_word_label,ground_truth_num_label`)
- `--image_root` (URL prefix if you already host images elsewhere)
- `--default_llm_cutoff` (default: `3`)

## Notes
- Images are resolved by `file_name` and served from `--image_dir` at `/images/<file_name>`.
- The app is self-hosted and uses only local data.
